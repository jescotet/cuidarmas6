document.addEventListener('DOMContentLoaded', () => {
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('.section-fade-in').forEach(section => observer.observe(section));

    // Animated WhatsApp Demo
    const chatArea = document.getElementById('chat-area');
    const statusText = document.getElementById('status-text');
    const replayDemoButton = document.getElementById('replay-demo');

    const demoMessages = [
        { from: 'in', text: '¬°Buenos d√≠as, Consuelo! üòä Espero que hayas descansado bien. Solo para recordarte que a las 10:00 tienes la pastilla para la tensi√≥n.' },
        { from: 'out', text: 'Vale, gracias hijo. Ahora mismo me la tomo.' },
        { from: 'in', text: '¬°Genial! Me quedo m√°s tranquilo. ¬øTe apetece que escuchemos un poco de tu m√∫sica favorita?' }
    ];

    function createMessageBubble(msg) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble message-${msg.from}`;
        bubble.innerHTML = `<p class="text-sm">${msg.text}</p>`;
        return bubble;
    }

    function createTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'message-bubble message-in typing-indicator';
        indicator.innerHTML = `<span></span><span></span><span></span>`;
        return indicator;
    }

    async function runDemo() {
        chatArea.innerHTML = '';
        for (let i = 0; i < demoMessages.length; i++) {
            const msg = demoMessages[i];
            if (msg.from === 'in') {
                statusText.textContent = 'Cuidar+ est√° escribiendo...';
                const indicator = createTypingIndicator();
                chatArea.appendChild(indicator);
                chatArea.scrollTop = chatArea.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 1500));
                chatArea.removeChild(indicator);
            }
            statusText.textContent = 'en l√≠nea';
            const bubble = createMessageBubble(msg);
            chatArea.appendChild(bubble);
            chatArea.scrollTop = chatArea.scrollHeight;
            await new Promise(resolve => setTimeout(resolve, msg.from === 'out' ? 1000 : 2000));
        }
    }
    replayDemoButton.addEventListener('click', runDemo);
    runDemo();

    // Animated Dashboard
    const alertsContainer = document.getElementById('alerts-container');
    const wellbeingEmoji = document.getElementById('wellbeing-emoji');
    const wellbeingText = document.getElementById('wellbeing-text');

    const alerts = [
        { type: 'info', text: 'Medicaci√≥n de las 10:00 confirmada.', border: 'var(--positive-green-border)' },
        { type: 'warning', text: 'Tono nost√°lgico detectado a las 18:32.', border: 'var(--alert-yellow-border)'},
        { type: 'urgent', text: '<strong>URGENTE:</strong> Detectada posible fuga de agua. Gestionando servicio.', border: 'var(--danger-red-border)'}
    ];

    async function runDashboardAnimation() {
        alertsContainer.innerHTML = '<p id="no-alerts" class="text-xs text-center text-text-light py-4">Monitorizando actividad...</p>';
        await new Promise(r => setTimeout(r, 2000));

        for (let i = 0; i < alerts.length; i++) {
             document.getElementById('no-alerts')?.remove();
            const alert = alerts[i];
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-item p-3 rounded-lg border-l-4';
            alertDiv.style.borderColor = alert.border;
            alertDiv.innerHTML = `<p class="font-semibold text-sm">${alert.text}</p>`;
            alertsContainer.prepend(alertDiv);

            await new Promise(r => setTimeout(r, 100));
            alertDiv.classList.add('visible');

            if (alert.type === 'urgent') {
                wellbeingEmoji.textContent = 'üòü';
                wellbeingEmoji.style.transform = 'scale(1.2)';
                wellbeingText.textContent = 'Atenci√≥n Requerida';
                wellbeingText.classList.add('text-red-800');
            }

            await new Promise(r => setTimeout(r, 3000));
        }
    }
    runDashboardAnimation();

    // Integration Demo
    const integrationContainer = document.getElementById('integration-steps');
    const replayIntegrationBtn = document.getElementById('replay-integration-demo');

    const integrationSteps = [
        `<strong>1. Detecci√≥n (WhatsApp):</strong> Consuelo env√≠a una nota de voz: "¬°Ay, se ha roto una tuber√≠a en el ba√±o y est√° saliendo agua!"`,
        `<strong>2. Interpretaci√≥n (IA Cuidar+):</strong> El LLM detecta la intenci√≥n de "aver√≠a dom√©stica" y la entidad "fuga de agua".`,
        `<strong>3. Orquestaci√≥n (Backend):</strong> Cuidar+ busca en su red de proveedores y se conecta a la API de 'Homeserve'.`,
        `<strong>4. Notificaci√≥n (Portal Cuidador):</strong> Javier recibe una alerta urgente en su dashboard: "‚ö†Ô∏è Fuga de agua detectada. Solicitud de fontanero en curso."`,
        `<strong>5. Acci√≥n y Confirmaci√≥n:</strong> Cuidar+ env√≠a a Javier: "‚úÖ Homeserve puede enviar un t√©cnico en 60 mins. ¬øAutorizas el servicio?"`
    ];

    async function runIntegrationDemo() {
        integrationContainer.innerHTML = '';
        for(let i = 0; i < integrationSteps.length; i++) {
            const stepEl = document.createElement('div');
            stepEl.className = 'p-2 my-1 rounded transition-opacity duration-500 opacity-0';
            stepEl.innerHTML = integrationSteps[i];
            integrationContainer.appendChild(stepEl);
            await new Promise(r => setTimeout(r, 100));
            stepEl.style.opacity = '1';
            await new Promise(r => setTimeout(r, 2500));
        }
    }
    replayIntegrationBtn.addEventListener('click', runIntegrationDemo);
    runIntegrationDemo();

    // Chart.js
    const chartTooltipConfig = { plugins: { tooltip: { callbacks: { title: (items) => Array.isArray(items[0].label) ? items[0].label.join(' ') : items[0].label } } } };
    const commonChartOptions = { responsive: true, maintainAspectRatio: false, plugins: { ...chartTooltipConfig.plugins, legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#eef' } } } };

    new Chart(document.getElementById('medicationChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
                label: 'Tomas',
                data: [2, 2, 1, 2, 2, 2, 1],
                backgroundColor: 'rgba(0, 169, 157, 0.6)',
                borderRadius: 4
            }]
        },
        options: {
            ...commonChartOptions,
            scales: {
                ...commonChartOptions.scales,
                y: {
                    beginAtZero: true,
                    max: 2,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('sentimentChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
                label: 'Sentimiento',
                data: [8, 8.5, 7, 7.5, 9, 6.5, 8],
                fill: true,
                borderColor: 'rgba(0, 90, 156, 1)',
                backgroundColor: 'rgba(0, 90, 156, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            ...commonChartOptions,
            scales: {
                ...commonChartOptions.scales,
                y: {
                    min: 0,
                    max: 10
                }
            }
        }
    });

    // Contact Form
    const contactFormContainer = document.getElementById('contact-form-container');
    document.getElementById('contact-form').addEventListener('submit', (e) => {
        e.preventDefault();
        contactFormContainer.innerHTML = `<div class="text-center p-8"><h3 class="text-2xl font-bold text-secondary-teal mb-4">¬°Gracias!</h3><p class="text-text-light">Hemos recibido tus datos. Nos pondremos en contacto contigo en breve.</p></div>`;
    });
});
